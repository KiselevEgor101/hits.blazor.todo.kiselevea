@page "/add-transaction"
@using TheFinalProject.Models
@using TheFinalProject.Data.Services
@inject TransactionService TransactionService
@inject DepartmentService DepartmentService
@inject AccountService AccountService
@inject NavigationManager NavManager

<h3>Добавить финансовую операцию</h3>

@if (!showForm)
{
    <div class="row mb-4">
        <div class="col-12">
            <div class="card h-100 text-center" style="cursor: pointer;" @onclick="() => SelectOperationType(false)">
                <div class="card-body d-flex flex-column justify-content-center">
                    <span class="bi bi-cash-coin" style="font-size: 3rem; color: #28a745;"></span>
                    <h4 class="mt-3">Доход / Расход</h4>
                    <p class="text-muted">Добавление финансовой операции</p>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <button class="btn btn-link mb-3" @onclick="() => showForm = false">
        <span class="bi bi-arrow-left"></span> Назад
    </button>

    <EditForm Model="transaction" OnValidSubmit="HandleValidSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary class="text-danger" />

        <div class="mb-3">
            <label class="form-label">Категория</label>
            <select class="form-control" @bind="selectedDepartmentId" @bind:after="OnDepartmentChanged">
                <option value="0">-- Выберите категорию --</option>
                @foreach (var dept in departments)
                {
                    <option value="@dept.Id">@dept.Name</option>
                }
            </select>
            @if (transaction.DepartmentId == 0)
            {
                <small class="text-danger">Выберите категорию</small>
            }
        </div>

        <div class="mb-3">
            <label class="form-label">Счёт</label>
            <select class="form-control" @bind="transaction.AccountId">
                <option value="0">-- Выберите счёт --</option>
                @foreach (var acc in availableAccounts)
                {
                    <option value="@acc.Id">@acc.DisplayName (@acc.Role)</option>
                }
            </select>
            @if (transaction.DepartmentId > 0 && !availableAccounts.Any())
            {
                <small class="text-warning">Для этой категории нет счетов</small>
            }
            else if (transaction.AccountId == 0 && availableAccounts.Any())
            {
                <small class="text-danger">Выберите счёт</small>
            }
        </div>

        <div class="mb-3">
            <label class="form-label">Тип операции</label>
            <InputSelect class="form-control" @bind-Value="transaction.OperationType">
                <option value="">-- Выберите тип --</option>
                <option value="Приход">Доход</option>
                <option value="Расход">Расход</option>
            </InputSelect>
            <ValidationMessage For="@(() => transaction.OperationType)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Сумма</label>
            <InputNumber class="form-control" @bind-Value="transaction.Amount" />
            <ValidationMessage For="@(() => transaction.Amount)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Описание</label>
            <InputText class="form-control" @bind-Value="transaction.Description" />
        </div>

        <button type="submit" class="btn btn-success">Сохранить</button>
        <a href="/transactions" class="btn btn-secondary">Отмена</a>
    </EditForm>
}

@code {
    private Transaction transaction = new() { Date = DateTime.UtcNow };
    private List<Department> departments = new();
    private List<Account> availableAccounts = new();
    private bool showForm = false;
    private int selectedDepartmentId = 0;

    protected override async Task OnInitializedAsync()
    {
        departments = await DepartmentService.GetDepartmentsAsync();
    }

    private void SelectOperationType(bool isTransfer)
    {
        showForm = true;
    }

    private async Task OnDepartmentChanged()
    {
        transaction.DepartmentId = selectedDepartmentId;

        if (selectedDepartmentId > 0)
        {
            availableAccounts = await AccountService.GetAccountsByDepartmentAsync(selectedDepartmentId);
        }
        else
        {
            availableAccounts.Clear();
        }

        transaction.AccountId = 0;
    }

    private async Task HandleValidSubmit()
    {
        await TransactionService.AddTransactionAsync(transaction);
        NavManager.NavigateTo("/transactions");
    }
}
